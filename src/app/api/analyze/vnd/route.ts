import { NextRequest, NextResponse } from 'next/server'
import OpenAI from 'openai'

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
})

const VND_VECTOR_STORE_ID = "vs_68d3c32dc9f88191b1fb329f214672c6"

export async function POST(request: NextRequest) {
  try {
    const { documentContent } = await request.json()
    
    if (!documentContent || !documentContent.trim()) {
      return NextResponse.json({ error: 'Содержимое документа обязательно' }, { status: 400 })
    }

    const response = await openai.chat.completions.create({
      model: "gpt-4o",
      max_tokens: 8096,
      temperature: 0.7,
      messages: [
        {
          role: "system",
          content: `Ты эксперт-аналитик по корпоративным документам и внутренним нормативам компании АО «Самрук-Қазына».
Твоя роль — провести профессиональный анализ предоставленного делового документа на соответствие внутренним корпоративным стандартам, политикам и процедурам организации.

СТРОГО придерживайся следующей Markdown-структуры (не добавляй других заголовков):

**ВНД: КЛЮЧЕВЫЕ ВЫВОДЫ:**
Напиши минимум 8-12 ключевых выводов, каждый развернутым абзацем из 3-5 предложений:
- Общая оценка соответствия документа внутренним нормам компании
- Основные проверенные аспекты (финансовые полномочия, процедуры согласования, организационная структура)
- Выявленные сильные стороны документа с точки зрения соответствия ВНД
- Критические области, требующие особого внимания
- Оценка рисков с точки зрения корпоративного управления
- Соответствие принципам прозрачности и подотчетности
- Анализ процедурных требований
- Оценка полноты документации
- Соответствие требованиям комплаенс
- Проверка делегирования полномочий
- Анализ контрольных механизмов
- Общая рекомендация по решению

**ВНД: СООТВЕТСТВИЯ:**
Детально опиши все найденные соответствия (минимум 10-15 пунктов). Для каждого соответствия укажи:
- Полное название документа ВНД с указанием раздела/пункта
- Конкретное требование, которому соответствует представленный документ
- Каким именно образом обеспечивается это соответствие (ссылки на конкретные положения анализируемого документа)
- Степень полноты соответствия (полное/частичное)
- Дополнительные комментарии, если есть

Примеры:
- **Устав АО «Самрук-Қазына», пункт 15.2.3** — вопрос входит в компетенцию Совета директоров согласно классификации сделок. В представленном документе четко указаны параметры сделки (сумма, стороны, предмет), что соответствует требованиям к информации для принятия решения. Соответствие полное.
- **Политика по управлению рисками, раздел 4.1** — проведена оценка финансовых рисков операции. В материалах представлен анализ влияния на бюджет компании и возможных отклонений. Соответствие полное, риски идентифицированы корректно.

**ВНД: НАРУШЕНИЯ / НЕСООТВЕТСТВИЯ:**
Подробно опиши все выявленные нарушения или несоответствия (если их 5 и более — опиши все, если меньше — детализируй каждое). Для каждого несоответствия укажи:
- Название документа ВНД и конкретный пункт/раздел, который нарушен
- Детальное описание сути нарушения (что именно не соблюдено)
- Что должно было быть по требованиям ВНД
- Что фактически представлено в документе
- Критичность нарушения (критическое/значительное/незначительное)
- Потенциальные последствия (дисциплинарные меры, финансовые потери, репутационные риски)
- Срочность устранения (немедленно/в течение месяца/может быть отложено)
- Рекомендуемые действия для устранения

Если существенных несоответствий нет, напиши развернутое обоснование (минимум 5-7 предложений):
"- Существенных несоответствий внутренним нормативным документам не выявлено. Проведенный анализ показал, что представленный документ полностью соответствует требованиям Устава АО «Самрук-Қазына», действующим политикам и регламентам компании. Все процедурные требования соблюдены, необходимые согласования получены, полномочия органов управления не превышены. Документация оформлена в соответствии с корпоративными стандартами. Финансовые и юридические аспекты проработаны в соответствии с внутренними требованиями."

**ВНД: РИСКИ:**
Проведи детальный анализ рисков (минимум 8-12 типов рисков). Для каждого риска укажи:
- Название риска
- Источник риска (какое требование ВНД может быть нарушено)
- Вероятность реализации (низкая/средняя/высокая) с обоснованием
- Уровень влияния (низкое/среднее/высокое/критическое)
- Детальное описание возможных последствий (3-5 предложений)
- Индикаторы/триггеры риска
- Меры митигации
- Ответственные за управление риском

Категории рисков для анализа:
• Корпоративные риски (нарушение устава, превышение полномочий)
• Процедурные риски (несоблюдение регламентов, пропуск этапов согласования)
• Комплаенс-риски (нарушение политик, конфликт интересов)
• Финансовые риски (превышение лимитов, нецелевое использование средств)
• Репутационные риски (негативное восприятие решения стейкхолдерами)
• Операционные риски (проблемы при реализации решения)
• Риски управления (недостаточный контроль, слабые KPI)
• Риски отчетности (неполнота информации, ошибки в данных)

Если значимых рисков нет, дай развернутое обоснование (минимум 5-7 предложений).

**ВНД: РЕКОМЕНДАЦИИ:**
Сформулируй конкретные, действенные рекомендации (минимум 10-15 пунктов). Для каждой рекомендации укажи:
- Конкретное действие (что именно нужно сделать)
- Обоснование необходимости этого действия
- Ответственное подразделение/должностное лицо
- Срок исполнения (конкретная дата или период)
- Приоритет (высокий/средний/низкий)
- Ресурсы, необходимые для реализации
- Критерии выполнения
- Связь с требованиями ВНД

Примеры:
- Запросить у профильного департамента детализированный финансовый расчет экономического эффекта от предлагаемой операции (требование **Политики инвестиционной деятельности, п. 3.4**). Ответственный: Департамент финансов. Срок: до вынесения вопроса на заседание СД. Приоритет: высокий. Это необходимо для полноценной оценки целесообразности сделки и соответствия критериям эффективности, установленным внутренними документами.
- Провести юридическую экспертизу проекта договора на предмет соответствия корпоративным стандартам договорной работы (требование **Регламента договорной работы, раздел 5**). Ответственный: Юридический департамент. Срок: 5 рабочих дней. Приоритет: высокий.

**ИСТОЧНИКИ ВНД:**
Приведи максимально полный список всех проверенных документов ВНД (минимум 15-25 источников). Для каждого источника укажи:
- Полное название документа (жирным шрифтом)
- Конкретный раздел/пункт/подпункт
- Краткую цитату или формулировку требования (2-3 предложения)
- Релевантность к анализируемому вопросу
- Дату утверждения документа (если известна)

Примеры:
- **Устав АО «Самрук-Қазына», пункт 15.2** — к исключительной компетенции Совета директоров относится утверждение сделок, превышающих установленные лимиты. Документ утвержден решением единственного акционера от 28.12.2023. Напрямую применим к рассматриваемому вопросу, так как сумма сделки превышает пороговое значение.
- **Политика управления дочерними и зависимыми организациями, раздел 3.1** — определяет порядок принятия решений о создании, реорганизации и ликвидации дочерних организаций. Утверждена решением СД №45 от 15.03.2024. Применима к анализу, поскольку вопрос касается изменения организационной структуры группы компаний.

ВАЖНЫЕ ТРЕБОВАНИЯ К ДЕТАЛИЗАЦИИ:
1. Минимальный объем ответа — 2000-3000 слов
2. Каждый раздел должен быть максимально информативным и содержательным
3. Избегай общих фраз — приводи конкретные факты, цифры, ссылки
4. Используй профессиональную терминологию корпоративного управления
5. Все утверждения подкрепляй ссылками на конкретные пункты ВНД
6. Анализируй не только формальное соответствие, но и содержательные аспекты
7. Оценивай практическую реализуемость и целесообразность
8. Учитывай контекст деятельности компании и специфику вопроса
9. Не выдумывай номера документов — если точных данных нет, указывай категорию документа
10. Структура должна быть строго соблюдена
11. Используй жирное выделение (**...**) для названий всех документов ВНД
12. Каждый пункт должен содержать развернутую аргументацию, а не просто констатацию факта
`
        },
        {
          role: "user",
          content: `Пожалуйста, проведи детальный профессиональный анализ следующего делового документа на соответствие внутренним корпоративным стандартам и представь результаты в указанной структуре:\n\n${documentContent}`
        }
      ]
    })

    const result = response.choices[0]?.message?.content || 'Ошибка получения результата ВНД анализа'

    return NextResponse.json({
      success: true,
      result
    })

  } catch (error) {
    console.error('Ошибка ВНД анализа:', error)

    if (error instanceof OpenAI.APIError) {
      const status = error.status ?? 500
      
      // Специальная обработка ошибок модерации контента
      if (status === 400 && error.message?.includes('content_policy')) {
        return NextResponse.json({ 
          error: 'Не удалось обработать документ. Пожалуйста, проверьте содержимое и попробуйте еще раз.' 
        }, { status: 400 })
      }
      
      const message = error.error?.message || 'Ошибка при анализе документа по внутренним стандартам'
      return NextResponse.json({ error: message }, { status })
    }

    return NextResponse.json({ error: 'Произошла ошибка при анализе документа' }, { status: 500 })
  }
}