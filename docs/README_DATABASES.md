# –°–æ–∑–¥–∞–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ PostgreSQL

## üìã –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–µ—Ç –¥–≤–µ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º PostgreSQL —Å–µ—Ä–≤–µ—Ä–µ:

1. **vnd** - –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–í–ù–î)
2. **npa** - –¥–ª—è –ø—Ä–∞–≤–æ–≤—ã—Ö –Ω–æ—Ä–º (–ù–ü–ê –†–ö)

## üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```
–°–µ—Ä–≤–µ—Ä: <YOUR_DB_HOST>:5433
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: postgres
–ü–∞—Ä–æ–ª—å: <YOUR_DB_PASSWORD>
```

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –¢—Ä–µ–±—É–µ—Ç—Å—è pgvector

–î–ª—è —Ä–∞–±–æ—Ç—ã –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö –±–∞–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ **pgvector** –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ PostgreSQL.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è pgvector

```bash
psql -h <YOUR_DB_HOST> -p 5433 -U <user> -d postgres -c "SELECT * FROM pg_available_extensions WHERE name LIKE '%vector%';"
```

–ï—Å–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —Å–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ —Ñ–∞–π–ª–µ `install_pgvector_instructions.md`

## üöÄ –í–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö

### –í–∞—Ä–∏–∞–Ω—Ç 1: Python —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install psycopg2-binary pgvector

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç
python create_vector_databases_simple.py
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö `vnd` –∏ `npa`
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã (IVFFlat)
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ (GIN + tsvector)
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏

### –í–∞—Ä–∏–∞–Ω—Ç 2: SQL –∫–æ–º–∞–Ω–¥—ã –≤—Ä—É—á–Ω—É—é

–ï—Å–ª–∏ Python —Å–∫—Ä–∏–ø—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ SQL —Ñ–∞–π–ª:

```bash
psql -h <YOUR_DB_HOST> -p 5433 -U <user> -f create_databases_manual.sql
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã "vnd"

### –¢–∞–±–ª–∏—Ü—ã:

1. **documents** - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   - `id` (UUID) - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
   - `filename` - –∏–º—è —Ñ–∞–π–ª–∞
   - `title` - –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
   - `lang` - —è–∑—ã–∫
   - `sha256` - —Ö–µ—à —Ñ–∞–π–ª–∞
   - `page_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü

2. **sections** - —Å–µ–∫—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –≤–µ–∫—Ç–æ—Ä–∞–º–∏
   - `id` (UUID)
   - `document_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç
   - `section_label` - –Ω–æ–º–µ—Ä —Å–µ–∫—Ü–∏–∏
   - `title` - –∑–∞–≥–æ–ª–æ–≤–æ–∫
   - `text` - —Ç–µ–∫—Å—Ç —Å–µ–∫—Ü–∏–∏
   - `embedding` vector(1024) - –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ

3. **subsections** - –ø–æ–¥—Å–µ–∫—Ü–∏–∏ —Å –≤–µ–∫—Ç–æ—Ä–∞–º–∏
   - `id` (UUID)
   - `document_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç
   - `section_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–µ–∫—Ü–∏—é
   - `title` - –∑–∞–≥–æ–ª–æ–≤–æ–∫
   - `text` - —Ç–µ–∫—Å—Ç
   - `embedding` vector(1024) - –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ

### –ò–Ω–¥–µ–∫—Å—ã:

- IVFFlat –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –∫–æ—Å–∏–Ω—É—Å–Ω–æ–º—É —Å—Ö–æ–¥—Å—Ç–≤—É
- B-tree –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Å–≤—è–∑–µ–π –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

### –ü—Ä–∏–º–µ—Ä –ø–æ–∏—Å–∫–∞:

```sql
-- –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —Å–µ–∫—Ü–∏–π
SELECT 
    s.title,
    s.text,
    d.filename,
    1 - (s.embedding <=> '[0.1, 0.2, ...]'::vector) AS similarity
FROM sections s
JOIN documents d ON s.document_id = d.id
ORDER BY s.embedding <=> '[0.1, 0.2, ...]'::vector
LIMIT 10;
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã "npa"

### –¢–∞–±–ª–∏—Ü—ã:

1. **document_metadata** - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ù–ü–ê
   - `id` (VARCHAR) - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞
   - `title` - –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ç–∞
   - `doc_type` - —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞
   - `doc_number` - –Ω–æ–º–µ—Ä
   - `adoption_date` - –¥–∞—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∏—è
   - `status` - —Å—Ç–∞—Ç—É—Å
   - `source_url` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫

2. **content_chunks** - —á–∞–Ω–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –≤–µ–∫—Ç–æ—Ä–∞–º–∏
   - `id` (SERIAL)
   - `doc_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç
   - `metadata` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —á–∞–Ω–∫–∞
   - `chunk` - —Ç–µ–∫—Å—Ç —á–∞–Ω–∫–∞
   - `chunk_tsv` (tsvector) - –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
   - `embedding` vector(1024) - –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ

### –ò–Ω–¥–µ–∫—Å—ã:

- IVFFlat –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
- GIN –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ (BM25)
- B-tree –¥–ª—è —Å–≤—è–∑–µ–π

### –¢—Ä–∏–≥–≥–µ—Ä—ã:

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `chunk_tsv` –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏

### –ü—Ä–∏–º–µ—Ä –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞:

```sql
-- BM25 –ø–æ–∏—Å–∫
SELECT doc_id, chunk, 
       ts_rank_cd(chunk_tsv, plainto_tsquery('russian', '–Ω–∞–ª–æ–≥')) AS score
FROM content_chunks
WHERE chunk_tsv @@ plainto_tsquery('russian', '–Ω–∞–ª–æ–≥')
ORDER BY score DESC
LIMIT 10;

-- –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
SELECT doc_id, chunk,
       1 - (embedding <=> '[0.1, 0.2, ...]'::vector) AS similarity
FROM content_chunks
ORDER BY similarity DESC
LIMIT 10;
```

## üîå –°—Ç—Ä–æ–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑:

```python
# –ë–∞–∑–∞ –í–ù–î
VND_DSN = "postgresql://<user>:<YOUR_DB_PASSWORD>@<YOUR_DB_HOST>:5433/vnd"

# –ë–∞–∑–∞ –ù–ü–ê
NPA_DSN = "postgresql://<user>:<YOUR_DB_PASSWORD>@<YOUR_DB_HOST>:5433/npa"
```

## üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤

### –î–ª—è internal_search.py (–í–ù–î):

```python
# –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –≤ –∫–æ–¥–µ:
DB_DSN = "postgresql://<user>:<YOUR_DB_PASSWORD>@<YOUR_DB_HOST>:5433/vnd"
```

### –î–ª—è rag_npa.py (–ù–ü–ê):

```python
# –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –≤ –∫–æ–¥–µ:
NPA_DB_DSN = "postgresql://<user>:<YOUR_DB_PASSWORD>@<YOUR_DB_HOST>:5433/npa"
```

## üì¶ –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

- `create_vector_databases_simple.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ë–î
- `create_databases_manual.sql` - SQL –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
- `install_pgvector_instructions.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ pgvector
- `README_DATABASES.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö:

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –±–∞–∑–µ vnd
psql -h <YOUR_DB_HOST> -p 5433 -U <user> -d vnd

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—ã
\dt

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–¥–µ–∫—Å—ã
\di

# –¢–æ –∂–µ –¥–ª—è npa
\c npa
\dt
\di
```

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **IVFFlat –∏–Ω–¥–µ–∫—Å—ã** –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ 100 —Å–ø–∏—Å–∫–æ–≤ (–ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–æ 100–ö –≤–µ–∫—Ç–æ—Ä–æ–≤)
2. –î–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö —É–≤–µ–ª–∏—á—å—Ç–µ `lists`:
   ```sql
   CREATE INDEX ... WITH (lists = 1000);  -- –¥–ª—è 1–ú+ –≤–µ–∫—Ç–æ—Ä–æ–≤
   ```

3. **Maintenance** - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ:
   ```sql
   VACUUM ANALYZE sections;
   VACUUM ANALYZE subsections;
   VACUUM ANALYZE content_chunks;
   ```

## üÜò –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –û—à–∏–±–∫–∞: "extension vector is not available"

‚û°Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pgvector –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—Å–º. `install_pgvector_instructions.md`)

### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞:
```bash
telnet <YOUR_DB_HOST> 5433
```

### –ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫

‚û°Ô∏è –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã:
```sql
SELECT indexname FROM pg_indexes WHERE tablename = 'sections';
```

## üìà –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pgvector (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
2. ‚úÖ –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ CSV —Ñ–∞–π–ª–æ–≤
4. ‚úÖ –û–±–Ω–æ–≤–∏—Ç–µ connection strings –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö
5. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–æ–∏—Å–∫

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ PostgreSQL –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–µ—Ä–≤–µ—Ä–∞.
